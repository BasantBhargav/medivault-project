<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MediVault | Patient Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --white: #ffffff;
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --transition: all 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7ff 0%, #e8edff 100%);
      color: var(--dark);
      display: flex;
      min-height: 100vh;
    }

    nav {
      width: 220px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .nav-header {
      font-size: 1.6rem;
      font-weight: bold;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .menu {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .menu a {
      color: var(--white);
      text-decoration: none;
      padding: 0.6rem 1rem;
      border-radius: var(--radius-sm);
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 500;
    }

    .menu a:hover, .menu a.active {
      background: rgba(255,255,255,0.1);
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .logout-btn {
      background: var(--danger);
      color: var(--white);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      transition: var(--transition);
    }

    .logout-btn:hover {
      background: #e5177e;
      box-shadow: 0 0 20px rgba(247, 37, 133, 0.5);
      transform: translateY(-2px);
    }

    main {
      margin-left: 220px;
      padding: 2rem 1.5rem;
      flex: 1;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.2rem;
    }

    .card {
      background: var(--white);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      padding: 1rem;
      position: relative;
      transition: var(--transition);
      overflow: hidden;
      cursor: pointer;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 4px;
      background: #b197fc;
      transition: width 0.3s ease;
      border-radius: 999px;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.12), 0 0 25px rgba(67, 97, 238, 0.3);
    }

    .card:hover::before {
      width: 80%;
    }

    .card .title {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card .value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-dark);
      word-wrap: break-word;
    }

    .upload-form {
      margin-top: 2rem;
      background: var(--white);
      padding: 1.5rem;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      position: relative;
      transition: var(--transition);
    }

    .upload-form:hover {
      box-shadow: 0 0 20px rgba(67, 97, 238, 0.2);
    }

    .upload-form h3 {
      margin-bottom: 1rem;
      color: var(--primary);
      font-weight: 600;
    }

    .upload-form input {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 0.8rem;
      border-radius: var(--radius-sm);
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .upload-form input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 10px rgba(67, 97, 238, 0.3);
    }

    /* Compact Upload Button */
    .upload-form button {
      background: var(--primary);
      color: var(--white);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      width: auto !important;
      padding: 0.4rem 1rem !important;
      font-size: 0.85rem !important;
      border-radius: var(--radius-sm);
      border: 1px solid transparent;
      align-self: flex-start;
      margin-bottom: 0.5rem;
    }

    .upload-form button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 0 15px rgba(67, 97, 238, 0.4);
    }

    .suggestions {
      position: absolute;
      background: var(--white);
      border: 1px solid #ccc;
      border-top: none;
      max-height: 150px;
      overflow-y: auto;
      width: calc(100% - 3rem);
      z-index: 10;
      display: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }

    .suggestions div {
      padding: 0.6rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .suggestions div:hover {
      background: #f1f1f1;
      color: var(--primary);
    }

    .filter-section {
      margin-top: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--white);
      padding: 1rem;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      transition: var(--transition);
    }

    .filter-section:hover {
      box-shadow: 0 0 15px rgba(67, 97, 238, 0.2);
    }

    .filter-section h2 {
      color: var(--primary);
      font-weight: 600;
      margin: 0;
    }

    .filter-section select {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      background: var(--white);
      transition: var(--transition);
    }

    .filter-section select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 10px rgba(67, 97, 238, 0.3);
    }

    .report-item {
      background: var(--white);
      border-radius: var(--radius-sm);
      padding: 1rem;
      margin: 1rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
    }

    .report-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15), 0 0 20px rgba(67, 97, 238, 0.25);
      border-left: 4px solid var(--primary);
    }

    .report-item .details {
      flex: 1;
    }

    .report-item .details strong {
      display: block;
      color: var(--dark);
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .report-item .details small {
      color: var(--gray);
      font-size: 0.85rem;
    }

    .report-item .actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      text-decoration: none;
      transition: var(--transition);
    }

    .btn:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    .btn-success { 
      background: var(--success); 
      color: white; 
    }
    .btn-success:hover {
      box-shadow: 0 0 15px rgba(76, 201, 240, 0.5);
    }

    .btn-primary { 
      background: var(--primary); 
      color: white; 
    }
    .btn-primary:hover {
      box-shadow: 0 0 15px rgba(67, 97, 238, 0.5);
    }

    .btn-danger { 
      background: var(--danger); 
      color: white; 
    }
    .btn-danger:hover {
      box-shadow: 0 0 15px rgba(247, 37, 133, 0.5);
    }

    .no-reports {
      margin-top: 1rem;
      padding: 3rem 2rem;
      text-align: center;
      background: var(--white);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      color: var(--gray);
      transition: var(--transition);
    }

    .no-reports:hover {
      box-shadow: 0 0 15px rgba(108, 117, 125, 0.2);
    }

    .no-reports i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Document-style Modal Design */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      animation: modalFadeIn 0.3s ease;
    }

    .modal-content {
      position: absolute;
      background: #ffffff;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 900px;
      height: 90vh;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
      border: 2px solid #e0e0e0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Window State Classes */
    .modal-content.minimized {
      width: 360px !important;
      height: 50px !important;
      border-radius: 8px;
      overflow: hidden;
      top: auto !important;
      bottom: 20px !important;
      left: 20px !important;
      right: auto !important;
      transform: none !important;
      cursor: pointer;
      animation: minimizeIn 0.3s ease;
      margin: 0 !important;
      max-width: none !important;
    }

    .modal-content.maximized {
      width: 100vw !important;
      height: 100vh !important;
      max-width: none !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      transform: none !important;
      border-radius: 0 !important;
      margin: 0 !important;
      animation: maximizeIn 0.3s ease;
      z-index: 2001;
    }

    /* Normal state definition */
    .modal-content:not(.minimized):not(.maximized) {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 900px;
      height: 90vh;
      border-radius: 8px;
    }

    /* Document Header */
    .modal-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 3px solid var(--primary);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      cursor: default;
    }

    .modal-header::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, #ddd, transparent);
    }

    .document-title {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      color: var(--dark);
    }

    .document-title .icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }

    .document-title .text {
      display: flex;
      flex-direction: column;
    }

    .document-title .main-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .document-title .sub-title {
      font-size: 0.85rem;
      color: var(--gray);
      font-weight: 500;
    }

    .window-controls {
      display: flex;
      gap: 0.3rem;
      align-items: center;
    }

    .control-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ddd;
      color: var(--dark);
      width: 36px;
      height: 36px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .control-btn:hover {
      background: var(--light);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 0 10px rgba(67, 97, 238, 0.3);
    }

    .control-btn.minimize:hover {
      background: #ffc107;
      border-color: #ffc107;
      color: white;
      box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
    }

    .control-btn.maximize:hover {
      background: #28a745;
      border-color: #28a745;
      color: white;
      box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }

    .control-btn.close {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .control-btn.close:hover {
      background: #c82333;
      border-color: #c82333;
      color: white;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
    }

    /* Document Body */
    .modal-body {
      padding: 0;
      height: calc(100% - 80px);
      background: #fafafa;
      position: relative;
      border: 1px solid #e9ecef;
      border-top: none;
    }

    .modal-body iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 4px;
    }

    /* Loading State */
    .modal-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      z-index: 10;
      background: rgba(255,255,255,0.95);
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .document-spinner {
      width: 35px;
      height: 35px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: documentSpin 1s linear infinite;
    }

    .loading-text {
      color: var(--gray);
      font-weight: 500;
      font-size: 0.9rem;
    }

    /* Animations */
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideIn {
      from { 
        transform: translate(-50%, -50%) scale(0.95);
        opacity: 0;
      }
      to { 
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    @keyframes minimizeIn {
      from { 
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      to { 
        transform: none scale(0.8);
        opacity: 1;
      }
    }

    @keyframes maximizeIn {
      from { 
        transform: translate(-50%, -50%) scale(0.9);
      }
      to { 
        transform: none scale(1);
      }
    }

    @keyframes documentSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      nav { 
        width: 100%; 
        height: auto; 
        position: static; 
        flex-direction: row; 
        justify-content: space-between; 
        padding: 1rem;
      }
      
      .nav-header { margin-bottom: 0; font-size: 1.2rem; }
      .menu { flex-direction: row; gap: 0.5rem; }
      .menu a { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
      
      main { margin-left: 0; padding: 1rem; }
      
      .modal-content { 
        width: 95%; 
        height: 95vh; 
      }
      
      .modal-header {
        padding: 0.8rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .document-title .main-title {
        font-size: 1rem;
      }
      
      .control-btn {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
      }

      .report-item { 
        flex-direction: column; 
        align-items: flex-start; 
      }
      
      .report-item .actions { 
        width: 100%; 
        justify-content: flex-start; 
        margin-top: 0.5rem; 
      }

      .filter-section {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .modal-content.minimized {
        width: calc(100% - 20px) !important;
        left: 10px !important;
        right: 10px !important;
      }

      /* Mobile upload button */
      .upload-form button {
        width: 100% !important;
        align-self: stretch;
      }
    }

    @media (max-width: 480px) {
      .modal-content:not(.minimized) {
        width: 100% !important;
        height: 100vh !important;
        margin: 0;
        border-radius: 0;
      }
    }
  </style>
</head>
<body id="top">

  <!-- Sidebar Navigation -->
  <nav>
    <div>
      <div class="nav-header"><i class="fas fa-heartbeat"></i> MediVault</div>
      <div class="menu">
        <a href="#top" class="active"><i class="fas fa-home"></i> Dashboard</a>
        <a href="#reports"><i class="fas fa-file-medical"></i> Reports</a>
        <a href="#prescription"><i class="fas fa-prescription-bottle-alt"></i> Prescription</a>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </nav>

  <!-- Main Content -->
  <main>
    <!-- Dashboard Cards -->
    <div class="grid">
      <div class="card">
        <div class="title"><i class="fas fa-id-card"></i> Patient ID</div>
        <div class="value" id="userId">Loading...</div>
      </div>
      <div class="card">
        <div class="title"><i class="fas fa-user"></i> Name</div>
        <div class="value" id="userName">Loading...</div>
      </div>
      <div class="card">
        <div class="title"><i class="fas fa-phone"></i> Phone</div>
        <div class="value" id="userPhone">Loading...</div>
      </div>
      <div class="card">
        <div class="title"><i class="fas fa-envelope"></i> Email</div>
        <div class="value" id="userEmail">Loading...</div>
      </div>
      <div class="card">
        <div class="title"><i class="fas fa-file-medical"></i> Total Reports</div>
        <div class="value" id="reportCount">0</div>
      </div>
    </div>

    <!-- Upload Section -->
    <form class="upload-form" id="uploadForm" enctype="multipart/form-data">
      <h3><i class="fas fa-upload"></i> Upload New Report</h3>
      <input type="text" id="reportType" name="reportType" placeholder="Report Type (e.g. X-Ray)" required autocomplete="off" />
      <div id="suggestions" class="suggestions"></div>
      <input type="file" name="report" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required />
      <button type="submit"><i class="fas fa-upload"></i> Upload Report</button>
    </form>

    <!-- Filter & Reports Section -->
    <div class="filter-section" id="reports">
      <h2><i class="fas fa-filter"></i> Reports</h2>
      <select id="filterSelect">
        <option value="all">Show All Reports</option>
      </select>
    </div>

    <!-- Reports List -->
    <div id="reportList">
      <div class="no-reports">
        <i class="fas fa-file-medical"></i>
        <div>No reports uploaded yet.</div>
      </div>
    </div>

    <!-- Placeholder for Prescription -->
    <div id="prescription" style="margin-top: 50px;">
      <h2><i class="fas fa-prescription-bottle-alt"></i> Prescriptions</h2>
      <div style="background: var(--white); padding: 2rem; border-radius: var(--radius-sm); box-shadow: var(--shadow-md); text-align: center; color: var(--gray);">
        <i class="fas fa-pills" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
        <div>Prescription management coming soon...</div>
      </div>
    </div>
  </main>

  <!-- Document-style Modal with Window Controls -->
  <div id="reportModal" class="modal">
    <div class="modal-content" id="modalBox">
      <div class="modal-header">
        <div class="document-title">
          <div class="icon">
            <i class="fas fa-file-medical"></i>
          </div>
          <div class="text">
            <div class="main-title" id="modalTitle">Medical Report</div>
            <div class="sub-title">Patient Document Viewer</div>
          </div>
        </div>
        
        <!-- Window Controls Only -->
        <div class="window-controls">
          <button class="control-btn minimize" id="minBtn" title="Minimize">
            <i class="fas fa-window-minimize"></i>
          </button>
          <button class="control-btn maximize" id="maxBtn" title="Maximize">
            <i class="fas fa-window-maximize"></i>
          </button>
          <button class="control-btn close" onclick="closeModal()" title="Close">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-loading" id="modalLoading">
          <div class="document-spinner"></div>
          <div class="loading-text">Loading document...</div>
        </div>
        <iframe id="reportFrame" src="" onload="hideLoading()"></iframe>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    let allReports = [];
    
    // Window control state
    const modal = document.getElementById('reportModal');
    const modalBox = document.getElementById('modalBox');
    const minBtn = document.getElementById('minBtn');
    const maxBtn = document.getElementById('maxBtn');
    let isMin = false;
    let isMax = false;
    
    const globalReportNames = [
      "X-Ray", "MRI", "CT Scan", "Blood Test", "Urine Test", "Liver Function Test",
      "Kidney Function Test", "Electrocardiogram (ECG)", "EEG", "Lipid Profile", "CBC",
      "Biopsy", "Histopathology", "Culture Test", "Stool Test", "Thyroid Function Test",
      "Glucose Tolerance Test", "Pap Smear", "Mammography", "PET Scan", "Ultrasound",
      "Bilirubin Test", "Electrolyte Panel", "Coagulation Profile", "Hemoglobin A1c",
      "Chest X-Ray", "Abdominal Ultrasound", "Serology", "Hormone Test", "DNA Test",
      "Genetic Screening", "Pathology Report", "Bone Density Test", "Sputum Test",
      "Vision Test", "Hearing Test", "Cardiac Stress Test", "Pulmonary Function Test",
      "Vitamin D Test", "Iron Studies", "Immunology Report", "Allergy Test", "COVID-19 Test"
    ];

    // Load Dashboard Data
    async function loadDashboard() {
      try {
        const res = await fetch('/api/patient-dashboard');
        const data = await res.json();
        allReports = data.reports;
        
        document.getElementById('userId').textContent = data.user._id;
        document.getElementById('userName').textContent = data.user.name || "N/A";
        document.getElementById('userPhone').textContent = data.user.phone || "N/A";
        document.getElementById('userEmail').textContent = data.user.email || "N/A";
        document.getElementById('reportCount').textContent = allReports.length;
        
        populateFilterOptions();
        renderReports(allReports);
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Populate Filter Options
    function populateFilterOptions() {
      const filterSelect = document.getElementById('filterSelect');
      // Clear existing options except first one
      while(filterSelect.children.length > 1) {
        filterSelect.removeChild(filterSelect.lastChild);
      }
      
      const types = [...new Set(allReports.map(r => r.reportType))];
      types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        filterSelect.appendChild(option);
      });
    }

    // Filter Reports
    document.getElementById('filterSelect').addEventListener('change', function () {
      const value = this.value;
      if (value === 'all') {
        renderReports(allReports);
      } else {
        const filtered = allReports.filter(r => r.reportType === value);
        renderReports(filtered);
      }
    });

    // Auto-complete for report types
    document.getElementById('reportType').addEventListener('input', function () {
      const input = this.value.toLowerCase();
      const suggestionsDiv = document.getElementById('suggestions');
      const suggestions = globalReportNames.filter(type =>
        type.toLowerCase().includes(input)
      );

      if (suggestions.length > 0 && input) {
        suggestionsDiv.innerHTML = suggestions.map(type => `<div>${type}</div>`).join('');
        suggestionsDiv.style.display = 'block';
      } else {
        suggestionsDiv.style.display = 'none';
      }
    });

    // Handle suggestion clicks
    document.getElementById('suggestions').addEventListener('click', function (e) {
      if (e.target.tagName === 'DIV') {
        document.getElementById('reportType').value = e.target.textContent;
        this.style.display = 'none';
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      const suggestions = document.getElementById('suggestions');
      const reportType = document.getElementById('reportType');
      if (!suggestions.contains(e.target) && e.target !== reportType) {
        suggestions.style.display = 'none';
      }
    });

    // Render Reports List
    function renderReports(reports) {
      const reportList = document.getElementById('reportList');
      if (reports.length === 0) {
        reportList.innerHTML = `
          <div class="no-reports">
            <i class="fas fa-file-medical"></i>
            <div>No reports found.</div>
          </div>`;
        return;
      }
      
      reportList.innerHTML = reports.map(r => `
        <div class="report-item">
          <div class="details">
            <strong>${r.reportType}</strong>
            <small>Uploaded: ${new Date(r.uploadedAt).toLocaleString()}</small>
          </div>
          <div class="actions">
            <button class="btn btn-success" onclick="openReportModal('${r.filePath}', '${r.reportType}')">
              <i class="fas fa-eye"></i> View
            </button>
            <a href="/${r.filePath}" download class="btn btn-primary">
              <i class="fas fa-download"></i> Download
            </a>
            <button class="btn btn-danger" onclick="deleteReport('${r._id}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>`).join('');
    }

    // Enhanced Window Controls
    minBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (!isMin) {
        // Minimize
        modalBox.classList.add('minimized');
        modalBox.classList.remove('maximized');
        isMin = true;
        isMax = false;
        minBtn.innerHTML = '<i class="fas fa-window-restore"></i>';
        minBtn.title = 'Restore';
        maxBtn.innerHTML = '<i class="fas fa-window-maximize"></i>';
        maxBtn.title = 'Maximize';
      } else {
        // Restore from minimized
        modalBox.classList.remove('minimized');
        isMin = false;
        minBtn.innerHTML = '<i class="fas fa-window-minimize"></i>';
        minBtn.title = 'Minimize';
      }
    });

    maxBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (!isMax) {
        // Maximize to full screen
        modalBox.classList.add('maximized');
        modalBox.classList.remove('minimized');
        isMax = true;
        isMin = false;
        maxBtn.innerHTML = '<i class="fas fa-compress"></i>';
        maxBtn.title = 'Restore';
        minBtn.innerHTML = '<i class="fas fa-window-minimize"></i>';
        minBtn.title = 'Minimize';
      } else {
        // Restore from maximized
        modalBox.classList.remove('maximized');
        isMax = false;
        maxBtn.innerHTML = '<i class="fas fa-window-maximize"></i>';
        maxBtn.title = 'Maximize';
      }
    });

    // Double click on header to toggle maximize
    document.querySelector('.modal-header').addEventListener('dblclick', function() {
      if (!isMax) {
        modalBox.classList.add('maximized');
        modalBox.classList.remove('minimized');
        isMax = true;
        isMin = false;
        maxBtn.innerHTML = '<i class="fas fa-compress"></i>';
        maxBtn.title = 'Restore';
      } else {
        modalBox.classList.remove('maximized');
        isMax = false;
        maxBtn.innerHTML = '<i class="fas fa-window-maximize"></i>';
        maxBtn.title = 'Maximize';
      }
    });

    // Restore from minimized state when clicking on the bar
    modalBox.addEventListener('click', function() {
      if (isMin) {
        modalBox.classList.remove('minimized');
        isMin = false;
        minBtn.innerHTML = '<i class="fas fa-window-minimize"></i>';
        minBtn.title = 'Minimize';
      }
    });

    // Document Modal Functions
    function openReportModal(filePath, reportType) {
      const iframe = document.getElementById('reportFrame');
      const title = document.getElementById('modalTitle');
      const loading = document.getElementById('modalLoading');
      
      title.textContent = reportType;
      loading.style.display = 'flex';
      iframe.style.display = 'none';
      iframe.src = '/' + filePath;
      modal.style.display = 'block';
      
      // Reset window state
      modalBox.classList.remove('minimized', 'maximized');
      isMin = false;
      isMax = false;
      minBtn.innerHTML = '<i class="fas fa-window-minimize"></i>';
      maxBtn.innerHTML = '<i class="fas fa-window-maximize"></i>';
      minBtn.title = 'Minimize';
      maxBtn.title = 'Maximize';
      
      document.body.style.overflow = 'hidden';
    }

    function hideLoading() {
      const loading = document.getElementById('modalLoading');
      const iframe = document.getElementById('reportFrame');
      setTimeout(() => {
        loading.style.display = 'none';
        iframe.style.display = 'block';
      }, 500);
    }

    function closeModal() {
      const iframe = document.getElementById('reportFrame');
      
      modal.style.display = 'none';
      iframe.src = '';
      
      // Reset window state
      modalBox.classList.remove('minimized', 'maximized');
      isMin = false;
      isMax = false;
      minBtn.innerHTML = '<i class="fas fa-window-minimize"></i>';
      maxBtn.innerHTML = '<i class="fas fa-window-maximize"></i>';
      
      document.body.style.overflow = 'auto';
    }

    // Event Listeners
    window.onclick = function(event) {
      if (event.target === modal && !isMin) {
        closeModal();
      }
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeModal();
      }
    });

    // Delete Report
    async function deleteReport(id) {
      if (!confirm('Are you sure you want to delete this report?')) return;
      
      try {
        await fetch(`/delete-report/${id}`, { method: 'DELETE' });
        loadDashboard();
      } catch (error) {
        alert('❌ Failed to delete report');
        console.error('Error deleting report:', error);
      }
    }

    // Upload Form Handler
    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
      submitBtn.disabled = true;
      
      try {
        const formData = new FormData(this);
        const res = await fetch('/upload-report', { method: 'POST', body: formData });
        
        if (res.ok) {
          alert('✅ Report uploaded successfully!');
          this.reset();
          document.getElementById('suggestions').style.display = 'none';
          loadDashboard();
        } else {
          alert('❌ Failed to upload report');
        }
      } catch (error) {
        alert('❌ Failed to upload report');
        console.error('Error uploading report:', error);
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Logout Function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        fetch('/logout', { method: 'POST' })
          .then(() => {
            location.href = '/login';
          })
          .catch(() => {
            location.href = '/login';
          });
      }
    }

    // Initialize Dashboard
    loadDashboard();
  </script>
</body>
</html>
